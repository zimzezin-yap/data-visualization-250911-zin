<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>한강 수난사고 타임라인 (신고/출동/구조/복귀)</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, sans-serif; margin: 16px; }
    #controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    label { font-size: 14px; }
    #chart { width: 100%; height: 85vh; }
    .hint { color: #666; font-size: 12px; }
    button, select { padding: 6px 10px; }
  </style>
</head>
<body>
  <h2>한강 수난사고: 사건별 시간 마커 (신고 · 출동 · 구조 · 복귀)</h2>
  <div id="controls">
    <button id="loadLocalBtn">CSV 불러오기</button>
    <input id="fileInput" type="file" accept=".csv" style="display:none" />
    <button id="loadProjectBtn">프로젝트 CSV 불러오기</button>
    <label class="hint">프로젝트 파일명: <code>수난사고_구조출동_2023_한강_수정본.csv</code></label>
  </div>
  <div id="chart"></div>
  <p class="hint">세로축: 사건 번호 (데이터 순서), 가로축: 분. 각 사건의 신고/출동/구조/복귀 시점을 색 점으로 표시합니다.</p>

  <script>
    const PROJECT_CSV_PATH = '수난사고_구조출동_2023_한강_수정본.csv';
    const EVENT_COLUMNS = ['신고', '출동', '구조', '복귀'];
    const EVENT_COLORS = { '신고': '#d62728', '출동': '#1f77b4', '구조': '#2ca02c', '복귀': '#9467bd' };

    function toMinutes(value) {
      if (value === null || value === undefined) return null;
      const s = String(value).trim();
      if (s === '' || s === '0' || s === '0:0') return 0;
      if (!s.includes(':')) {
        const m = Number(s);
        return Number.isFinite(m) ? m : null;
      }
      const parts = s.split(':');
      if (parts.length !== 2) return null;
      const h = Number(parts[0]);
      const m = Number(parts[1]);
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h * 60 + m;
    }

    function buildTraces(rows) {
      const traces = [];
      const yLabels = [];

      rows.forEach((row, idx) => {
        yLabels.push(row['사건'] ? String(row['사건']) : String(idx + 1));
      });

      EVENT_COLUMNS.forEach(col => {
        const x = [];
        const y = [];
        const text = [];
        rows.forEach((row, idx) => {
          const minutes = toMinutes(row[col]);
          if (minutes !== null && !Number.isNaN(minutes)) {
            x.push(minutes);
            y.push(idx + 1);
            text.push(`${col}: ${row[col]}`);
          }
        });
        traces.push({
          x,
          y,
          text,
          type: 'scattergl',
          mode: 'markers',
          name: col,
          marker: { size: 6, color: EVENT_COLORS[col] || '#333' },
          hovertemplate: '사건 %{y}<br>%{text}<extra></extra>'
        });
      });

      return { traces, yLabels };
    }

    function computeXMax(rows) {
      let xmax = 0;
      rows.forEach(row => {
        EVENT_COLUMNS.forEach(col => {
          const v = toMinutes(row[col]);
          if (v !== null && !Number.isNaN(v)) xmax = Math.max(xmax, v);
        });
      });
      return xmax;
    }

    function drawChart(rows) {
      const { traces, yLabels } = buildTraces(rows);
      const xmax = computeXMax(rows);
      const xpad = 5;
      const layout = {
        title: '한강 수난사고: 사건별 시간 마커 (신고/출동/구조/복귀)',
        xaxis: { title: '분', range: [-xpad, xmax + xpad], zeroline: false, gridcolor: '#eee' },
        yaxis: { title: '사건', tickmode: 'array', tickvals: yLabels.map((_, i) => i + 1), ticktext: yLabels },
        legend: { orientation: 'h' },
        margin: { t: 40, r: 20, b: 60, l: 60 },
        hovermode: 'closest',
        height: window.innerHeight * 0.85
      };
      const config = { responsive: true, displaylogo: false, modeBarButtonsToRemove: ['select2d', 'lasso2d'] };
      Plotly.newPlot('chart', traces, layout, config);
    }

    function parseCsvText(csvText) {
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      if (parsed.errors && parsed.errors.length) {
        console.warn('CSV parse errors:', parsed.errors);
      }
      const rows = parsed.data.map(row => {
        const cleaned = {};
        Object.keys(row).forEach(k => {
          if (!k || /^Unnamed/i.test(k)) return;
          cleaned[k.trim()] = typeof row[k] === 'string' ? row[k].trim() : row[k];
        });
        return cleaned;
      });
      const required = ['사건', ...EVENT_COLUMNS];
      const hasAll = required.every(c => rows.length === 0 || Object.prototype.hasOwnProperty.call(rows[0], c));
      if (!hasAll) {
        console.warn('헤더 확인 필요. 감지된 헤더:', Object.keys(rows[0] || {}));
      }
      return rows;
    }

    async function loadProjectCsv() {
      try {
        const res = await fetch(PROJECT_CSV_PATH);
        if (!res.ok) throw new Error('CSV fetch 실패: ' + res.status);
        const text = await res.text();
        const rows = parseCsvText(text);
        drawChart(rows);
      } catch (err) {
        alert('프로젝트 CSV를 불러오지 못했습니다. 보안 정책으로 로컬 파일 접근이 차단될 수 있습니다.\n"CSV 불러오기" 버튼으로 직접 파일을 선택하세요.');
        console.error(err);
      }
    }

    function loadLocalCsvFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        const rows = parseCsvText(reader.result);
        drawChart(rows);
      };
      reader.readAsText(file, 'utf-8');
    }

    document.getElementById('loadLocalBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (file) loadLocalCsvFile(file);
    });
    document.getElementById('loadProjectBtn').addEventListener('click', loadProjectCsv);

    loadProjectCsv();

    window.addEventListener('resize', () => {
      const chart = document.getElementById('chart');
      Plotly.relayout(chart, { height: window.innerHeight * 0.85 });
    });
  </script>
</body>
</html>
