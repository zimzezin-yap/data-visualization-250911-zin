<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>세계 학생 교육 성취도 (UNESCO)</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, sans-serif; margin: 0; }
  header { padding: 16px 20px; border-bottom: 1px solid #eee; }
  .container { padding: 16px 20px; }
  .chart-wrap { position: relative; }
  svg { width: 100%; height: 70vh; }
  .axis path, .axis line { stroke: #bbb; }
  .line { fill: none; stroke-width: 1.5px; opacity: 0.6; transition: opacity .2s, stroke-width .2s; }
  .line:hover { cursor: pointer; }
  .country-label-big {
    position: absolute;
    left: 50%;
    top: 10px;
    transform: translateX(-50%);
    font-size: clamp(16px, 5vw, 48px);
    font-weight: 800;
    pointer-events: none;
    opacity: 0;
    transition: opacity .15s;
  }
  .muted { opacity: 0.15; }
  .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
  button { padding: 6px 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; }
  button:hover { background: #f2f2f2; }

  /* 툴팁 */
  .tooltip {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    color: #333;
    pointer-events: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    opacity: 0;
    transition: opacity .15s;
  }
</style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size:clamp(18px, 3vw, 28px)">세계 학생 교육 성취도 — 연도별 추이</h1>
  </header>
  <div class="container">
    <div class="controls">
      <button id="showAll">전체 보기</button>
      <button id="clearAll">모두 흐리게</button>
      <input id="search" type="search" placeholder="국가명 검색…" style="flex:1; padding:6px 10px; border:1px solid #ddd; border-radius:8px"/>
    </div>
    <div class="chart-wrap">
      <div class="country-label-big" id="bigLabel"></div>
      <div class="tooltip" id="tooltip"></div>
      <svg id="chart"></svg>
    </div>
  </div>

<script>
const data = __DATA__; // JSON 데이터 넣기

const svg = d3.select("#chart");
const margin = {top: 40, right: 28, bottom: 40, left: 48};
let width = svg.node().clientWidth;
let height = svg.node().clientHeight;
const innerW = width - margin.left - margin.right;
const innerH = height - margin.top - margin.bottom;

const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

const allYears = Array.from(new Set(data.flatMap(d => d.series.map(p => p.year)))).sort((a,b)=>a-b);
const minYear = Math.min(...allYears), maxYear = Math.max(...allYears);
const allValues = data.flatMap(d => d.series.map(p => p.value));
const minVal = Math.min(...allValues), maxVal = Math.max(...allValues);

const x = d3.scaleLinear().domain([minYear, maxYear]).range([0, innerW]);
const y = d3.scaleLinear().domain([Math.floor(minVal/5)*5, Math.ceil(maxVal/5)*5]).nice().range([innerH, 0]);

g.append("g").attr("transform", `translate(0, ${innerH})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
g.append("g").call(d3.axisLeft(y));

const color = d3.scaleOrdinal(d3.schemeTableau10);
const line = d3.line().x(d => x(d.year)).y(d => y(d.value));

const countryG = g.selectAll(".country")
  .data(data).join("g").attr("class", "country");

countryG.append("path")
  .attr("class", "line")
  .attr("d", d => line(d.series))
  .attr("stroke", (d,i) => color(d.country));

const bigLabel = d3.select("#bigLabel");
const tooltip = d3.select("#tooltip");

countryG
  .on("mousemove", function(event, d){
    const [mx] = d3.pointer(event, this);
    // 가장 가까운 연도 찾기
    const bisect = d3.bisector(p => p.year).left;
    const yearScale = x.invert(mx);
    const idx = bisect(d.series, yearScale);
    const point = d.series[Math.min(d.series.length-1, Math.max(0, idx))];

    d3.selectAll(".line").classed("muted", true);
    d3.select(this).select(".line").classed("muted", false).attr("stroke-width", 3);

    bigLabel.text(d.country).style("opacity", 1);

    tooltip.style("opacity", 1)
      .style("left", (event.pageX + 12) + "px")
      .style("top", (event.pageY - 20) + "px")
      .html(`<strong>${d.country}</strong><br/>${point.year}: ${point.value}`);
  })
  .on("mouseleave", function(){
    d3.selectAll(".line").classed("muted", false).attr("stroke-width", 1.5);
    bigLabel.style("opacity", 0);
    tooltip.style("opacity", 0);
  });
</script>
</body>
</html>
