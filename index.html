import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from datetime import datetime
import numpy as np

# 한글 폰트 설정
plt.rcParams['font.family'] = 'DejaVu Sans'
plt.rcParams['axes.unicode_minus'] = False

# 데이터 로드
df = pd.read_csv('/Users/gim-yejin/Desktop/데이터시각화/서울소방재난본부_(한강)수난사고 구조출동 현황/수난사고_구조출동_2023_한강/수난사고_구조출동_2023_한강.csv')

# 시간 데이터 전처리 함수
def convert_time_to_hour(time_str):
    """시간 문자열을 시간(0-23)으로 변환"""
    if pd.isna(time_str) or time_str == '':
        return None
    
    time_str = str(int(time_str)).zfill(6)
    hour = int(time_str[:2])
    
    # 24시간을 초과하는 경우 처리
    if hour >= 24:
        hour = hour % 24
    
    return hour

# 시간 데이터 처리
df['신고일자'] = pd.to_datetime(df['신고일자'], format='%Y%m%d')
df['신고시각_hr'] = df['신고시각'].apply(convert_time_to_hour)
df['출동시각_hr'] = df['출동시각'].apply(convert_time_to_hour)
df['현장도착시각_hr'] = df['현장도착시각'].apply(convert_time_to_hour)
df['구조완료시각_hr'] = df['구조완료시각'].apply(convert_time_to_hour)
df['복귀시간_hr'] = df['복귀시간'].apply(convert_time_to_hour)

# 유효한 데이터만 필터링
df_clean = df.dropna(subset=['신고시각_hr', '출동시각_hr', '현장도착시각_hr', '구조완료시각_hr', '복귀시간_hr'])

# 샘플 데이터 (처리 속도를 위해 처음 100개 행만 사용)
df_sample = df_clean.head(100).copy()

# 시각화 생성
fig, ax = plt.subplots(figsize=(20, 12))

# 색상 정의
colors = {
    '신고시각': '#FF4444',      # 빨간색
    '출동시각': '#00A8CC',      # 청록색
    '현장도착시각': '#0066CC',  # 파란색
    '구조완료시각': '#00CC66',  # 연두색
    '복귀시간': '#FFCC00'       # 노란색
}

# 각 사고별로 시간대별 마커 표시
y_positions = []
for idx, row in df_sample.iterrows():
    y_pos = len(y_positions)
    y_positions.append(row['신고일자'])
    
    # 각 시간대별로 점 표시
    times = [
        ('신고시각', row['신고시각_hr']),
        ('출동시각', row['출동시각_hr']),
        ('현장도착시각', row['현장도착시각_hr']),
        ('구조완료시각', row['구조완료시각_hr']),
        ('복귀시간', row['복귀시간_hr'])
    ]
    
    for time_type, hour in times:
        if hour is not None and 0 <= hour < 24:
            ax.scatter(hour, y_pos, 
                      c=colors[time_type], s=100, alpha=0.8, 
                      label=time_type if idx == 0 else "", 
                      edgecolors='black', linewidth=0.5)

# 시간축 설정
ax.set_xlim(-0.5, 23.5)
ax.set_xticks(range(0, 24, 2))
ax.set_xticklabels([f'{h:02d}:00' for h in range(0, 24, 2)])

# y축 설정 (신고일자)
ax.set_ylim(-0.5, len(y_positions) - 0.5)
ax.set_yticks(range(len(y_positions)))
ax.set_yticklabels([date.strftime('%m-%d') for date in y_positions])

# 격자 설정
ax.grid(True, alpha=0.3, axis='x')
ax.set_axisbelow(True)

# 레이블과 제목
ax.set_xlabel('시간 (24시간)', fontsize=14, fontweight='bold')
ax.set_ylabel('신고일자', fontsize=14, fontweight='bold')
ax.set_title('한강 수난사고 구조출동 현황 - 시간대별 분석\n(신고시각, 출동시각, 현장도착시각, 구조완료시각, 복귀시간)', 
             fontsize=16, fontweight='bold', pad=20)

# 범례 설정
legend_elements = [plt.Line2D([0], [0], marker='o', color='w', markerfacecolor=color, 
                             markersize=12, label=label, markeredgecolor='black')
                  for label, color in colors.items()]
ax.legend(handles=legend_elements, loc='upper right', bbox_to_anchor=(1.0, 1.0))

# 레이아웃 조정
plt.tight_layout()

# 그래프 저장
plt.savefig('/Users/gim-yejin/Desktop/데이터시각화/hangang_rescue_simple.png', 
            dpi=300, bbox_inches='tight', facecolor='white')

plt.show()

# 통계 정보 출력
print("=== 한강 수난사고 구조출동 데이터 분석 ===")
print(f"총 사고 건수: {len(df_clean)}")
print(f"분석 기간: {df_clean['신고일자'].min().strftime('%Y-%m-%d')} ~ {df_clean['신고일자'].max().strftime('%Y-%m-%d')}")
print(f"표시된 샘플 건수: {len(df_sample)}")

# 시간대별 사고 발생 현황
print("\n=== 시간대별 사고 발생 현황 ===")
hourly_counts = df_clean['신고시각_hr'].value_counts().sort_index()
for hour, count in hourly_counts.items():
    print(f"{hour:02d}시: {count}건")

# 각 단계별 평균 소요시간 계산
print("\n=== 각 단계별 평균 소요시간 ===")
df_sample['신고_출동_소요시간'] = df_sample['출동시각_hr'] - df_sample['신고시각_hr']
df_sample['출동_도착_소요시간'] = df_sample['현장도착시각_hr'] - df_sample['출동시각_hr']
df_sample['도착_완료_소요시간'] = df_sample['구조완료시각_hr'] - df_sample['현장도착시각_hr']
df_sample['완료_복귀_소요시간'] = df_sample['복귀시간_hr'] - df_sample['구조완료시각_hr']

print(f"신고 → 출동: {df_sample['신고_출동_소요시간'].mean():.1f}시간")
print(f"출동 → 현장도착: {df_sample['출동_도착_소요시간'].mean():.1f}시간")
print(f"현장도착 → 구조완료: {df_sample['도착_완료_소요시간'].mean():.1f}시간")
print(f"구조완료 → 복귀: {df_sample['완료_복귀_소요시간'].mean():.1f}시간")
